name: Release artifacts

on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      tag_version:
        description: 'Tag version:'
        required: true

permissions:
    id-token: write # This is required for requesting the JWT
    contents: write # This is required for actions/checkout
    
jobs:
  define-release-version:
    name: Define Release Version
    runs-on: ubuntu-24.04

    outputs:
      version: ${{ steps.set-tag-version.outputs.tag_version }}
    
    steps:
      - name: Define release version
        id: set-tag-version
        run: |
          if [[ -n "$GITHUB_REF" && "$GITHUB_REF" == refs/tags/* ]]; then
            echo "tag_version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          elif [[ -n "$INPUT_TAG_VERSION" ]]; then
            echo "tag_version=$INPUT_TAG_VERSION" >> $GITHUB_OUTPUT
          else
            echo "No tag version found."
            exit 1
          fi
        env:
          INPUT_TAG_VERSION: ${{ github.event.inputs.tag_version }}
      
  release-artifacts-docker:
    name: Release Artifacts Docker
    runs-on: ubuntu-24.04
    needs: define-release-version

    env:
      IMAGE_TAG: ${{ needs.define-release-version.outputs.version }}
      DOCKERHUB_IMAGE_NAME: docker.io/rasa/orela-test
      GAR_IMAGE_NAME: europe-west3-docker.pkg.dev/rasa-releases/rasa-sdk/rasa-sdk    
  
    steps:
      - name: Check out code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          ref: ${{ needs.define-release-version.outputs.version }}
          
      - name: Set up QEMU
        uses: docker/setup-qemu-action@4574d27a4764455b42196d70a065bc6853246a25 # v3.4.0
        with:
          platforms: linux/amd64,linux/arm64
          # The latest version will lead to segmentation fault.
          image: tonistiigi/binfmt:qemu-v7.0.0-28

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f7ce87c1d6bead3e36075b2ce75da1f6cc28aaca  # v3.9.0

      - name: Login to Docker Hub Registry üî¢
        run: echo ${{ secrets.DOCKER_HUB_PASSWORD }} | docker login -u ${{ secrets.DOCKER_HUB_USERNAME }} --password-stdin 

      - name: Authenticate with gcloud for release registry üé´
        id: 'auth-release'
        uses: 'google-github-actions/auth@ef5d53e30bbcd8d0836f4288f5e50ff3e086997d'
        with:
            workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
            service_account: '${{ secrets.RASA_SDK_RELEASE_ACCOUNT_NAME }}'
            
      - name: Authenticate docker for release registry üé´
        run: gcloud auth configure-docker europe-west3-docker.pkg.dev

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad
        with:
          cosign-release: 'v3.0.2'

      - name: Build and Push Docker image to the DockerHub 
        run: |
          make build-and-push-multi-platform-docker
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          IMAGE_NAME: ${{ env.DOCKERHUB_IMAGE_NAME }}

      - name: Resolve DockerHub manifest digest
        id: dockerhub-digest
        run: |
          IMAGE="${DOCKERHUB_IMAGE_NAME}:${IMAGE_TAG}"
          
          # Extract the main Digest line (not the manifest-specific ones)
          DIGEST=$(docker buildx imagetools inspect "$IMAGE" | grep -E '^Digest:' | awk '{print $2}')
          
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"
          echo "DockerHub manifest digest: ${DIGEST}" 

      - name: Sign DockerHub image
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          IMAGE_REF="${DOCKERHUB_IMAGE_NAME}:${IMAGE_TAG}"
          DIGEST_REF="${DOCKERHUB_IMAGE_NAME}@${{ steps.dockerhub-digest.outputs.digest }}"
          
          echo "Signing multi-arch image: $DIGEST_REF"
          
          # Sign the manifest list 
          cosign sign --yes "$DIGEST_REF"
          
          # Optional: Also recursively sign each platform-specific image
          # cosign sign --yes --recursive "$DIGEST_REF"
          
          echo "Signature created successfully"

      - name: Verify DockerHub signature
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          DIGEST_REF="${DOCKERHUB_IMAGE_NAME}@${{ steps.dockerhub-digest.outputs.digest }}"
          
          # Use the repository path for identity verification
          EXPECTED_IDENTITY="https://github.com/${{ github.repository }}/.github/workflows/${{ github.workflow }}@${{ github.ref }}"
          
          echo "Verifying: $DIGEST_REF"
          echo "Expected identity: $EXPECTED_IDENTITY"
          
          cosign verify \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity-regexp "^https://github.com/${{ github.repository }}/" \
            "$REF" | jq .      

      - name: Build and Push Docker image to the GCP 
        run: |
          make build-and-push-multi-platform-docker
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          IMAGE_NAME: ${{ env.GAR_IMAGE_NAME }}

      - name: Get image digest from GAR
        id: gar-digest
        run: |
          IMAGE="${GAR_IMAGE_NAME}:${IMAGE_TAG}"
          DIGEST="$(docker buildx imagetools inspect "$IMAGE" --format '{{json .Manifest}}' | jq -r '.digest')"
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"
          echo "GAR manifest digest: $DIGEST"      

      - name: sign GAR by digest
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          REF="${GAR_IMAGE_NAME}@${{ steps.gar-digest.outputs.digest }}"
          echo "Signing $REF"
          cosign sign --yes "$REF"

      - name: Verify GAR signature (CI) 
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          REF="${GAR_IMAGE_NAME}@${{ steps.gar-digest.outputs.digest }}"
          EXPECTED_IDENTITY="https://github.com/${{ github.workflow_ref }}"
          echo "Verifying $REF"
          echo "Expected identity: $EXPECTED_IDENTITY"

          cosign verify \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity "$EXPECTED_IDENTITY" \
            "$REF"
            
  release-artifacts-pypi:
    name: Release Artifacts PyPI
    runs-on: ubuntu-24.04
    needs: define-release-version
    
    steps:
      - name: Checkout git repository üïù
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          ref: ${{ needs.define-release-version.outputs.version }}

      - name: Set up Python 3.10 üêç
        uses: actions/setup-python@d27e3f3d7c64b4bbf8e4abfb9b63b83e846e0435
        with:
          python-version: '3.10'

      - name: Read Poetry Version üî¢
        run: |
          echo "POETRY_VERSION=$(scripts/poetry-version.sh)" >> $GITHUB_ENV
        shell: bash

      - name: Install poetry ü¶Ñ
        uses: Gr1N/setup-poetry@15821dc8a61bc630db542ae4baf6a7c19a994844
        with:
          poetry-version: ${{ env.POETRY_VERSION }}

      - name: Build ‚öíÔ∏è Distributions
        run: poetry build

      - name: Publish to PyPI üì¶
        uses: pypa/gh-action-pypi-publish@bea5cda687c2b79989126d589ef4411bedce0195
        with:
          user: __token__
          password: ${{ secrets.PYPI_TOKEN }}
          skip_existing: true

  release-atifacts-publish-release:
    name: Release Artifacts Publish Release
    runs-on: ubuntu-24.04
    needs: [define-release-version, release-artifacts-docker, release-artifacts-pypi]

    steps:
      - name: Check out code
        if: success()
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          ref: ${{ needs.define-release-version.outputs.version }}
      
      - name: Publish Release Notes üóû
        if: success()
        env:
          GITHUB_TAG: ${{ needs.define-release-version.outputs.version }}
          GITHUB_REPO_SLUG: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.RASASDK_GITHUB_TOKEN }}
        run: |
          GITHUB_TAG=$GITHUB_TAG
          pip install -U github3.py pep440-version-utils
          python3 scripts/publish_gh_release_notes.py

  release-artifact-slack-notifications:
    name: Release Analytics Artifact Slack Notifications
    runs-on: ubuntu-24.04
    needs: [define-release-version, release-artifacts-docker, release-artifacts-pypi, release-atifacts-publish-release]

    if: always()  # Ensures this job runs regardless of the result of previous jobs

    steps:
      - name: Notify Slack of successful release üí¨
        if: ${{ needs.release-artifacts-docker.result == 'success' && needs.release-artifacts-pypi.result == 'success' }}
        uses: slackapi/slack-github-action@6c661ce58804a1a20f6dc5fbee7f0381b469e001 #v 1.25.0
        with:
          # Send notification to #release slack channel
          channel-id: "C024Z61K9QU"
          slack-message: ":rocket: New *Rasa SDK* version `${{ needs.define-release-version.outputs.version }}` has been released! More information can be found <https://github.com/RasaHQ/rasa-sdk/releases/tag/${{ needs.define-release-version.outputs.version }}|here>."
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Notify Slack of unsuccessful release ‚õîÔ∏è
        if: ${{ needs.release-artifacts-docker.result != 'success' || needs.release-artifacts-pypi.result != 'success' }}
        uses: slackapi/slack-github-action@6c661ce58804a1a20f6dc5fbee7f0381b469e001 #v 1.25.0
        with:
          # Send notification to ##prodeng-internal slack channel
          channel-id: "C36SS4N8M"
          slack-message: ":broken_heart: *Rasa SDK* release version `${{ needs.define-release-version.outputs.version }}` has failed! More information can be found <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|here>."
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
