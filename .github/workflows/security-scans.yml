# ================================================================
# 🛡️ Security Checks Workflow
# ================================================================
# This GitHub Actions workflow performs automated security checks
# on every pull request. It includes:
#
# 1. Trivy - Detects hardcoded secrets in the repository.
# 2. Gitleaks - Scans for potential secrets using a reusable workflow.
# 3. Slack Alert - Sends a notification to #infrasec-alert if any
#    security job fails.
#
# Jobs:
#   - trivy: Runs a local filesystem scan for secrets.
#   - gitleaks: Invokes the centralized secret scanning workflow.
#   - alert_on_failures: Summarizes and alerts on any failures.
#
# ================================================================

name: Security Checks

on: [pull_request]

jobs:
  trivy:
    name: Run Trivy vulnerability scan
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # Fetch all history for all tags and branches
          fetch-depth: 0

      - name: Run Trivy vulnerability scanner
        id: trivy
        uses: aquasecurity/trivy-action@dc5a429b52fcf669ce959baa2c2dd26090d2a6c4 # v0.32.0
        continue-on-error: true
        with:
          format: table
          scan-type: fs
          exit-code: 1
          scanners: secret

      - name: Fail build if a secret is found
        if: steps.trivy.outcome == 'failure'
        run: |
          echo "=========================================================="
          echo "| This build has failed because Trivy detected a secret. |"
          echo "=========================================================="
          echo "1. Check the step 'Run Trivy vulnerability scanner' for output to help you find the secret."
          echo "2. If the finding is a false positive, add it as an entry to trivy-secret.yaml in the root of the repo to suppress the finding."
          echo "3. If the finding is valid, the security team can help advise your next steps."
          exit 1
  
  gitleaks:
    name: Run Gitleaks secret scan
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1
        with:
          fetch-depth: 0

      - name: Run Gitleaks Scan
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  alert_on_failures:
    name: Alert on failures (Slack on #infrasec-alert)
    needs: [trivy, gitleaks]
    runs-on: ubuntu-24.04
    if: always()

    steps:
      - name: Check job failures and create summary
        id: summary
        run: |
          failed_jobs=""

          if [ "${{ needs.trivy.result }}" == "failure" ]; then
            failed_jobs="${failed_jobs}• Trivy: ${{ needs.trivy.result }}\n"
          fi

          if [ "${{ needs.gitleaks.result }}" == "failure" ]; then
            failed_jobs="${failed_jobs}• Gitleaks: ${{ needs.gitleaks.result }}\n"
          fi

          if [ "${{ needs.bandit.result }}" == "failure" ]; then
            failed_jobs="${failed_jobs}• Bandit: ${{ needs.bandit.result }}\n"
          fi

          if [ -n "$failed_jobs" ]; then
            echo "failed=true" >> $GITHUB_OUTPUT
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "Failed jobs:" >> $GITHUB_OUTPUT
            echo "$failed_jobs" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "failed=false" >> $GITHUB_OUTPUT
            echo "summary=All security scans passed successfully" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: steps.summary.outputs.failed == 'true'
        uses: slackapi/slack-github-action@485a9d42d3a73031f12ec201c457e2162c45d02d # v2.0.0
        with:
          webhook: ${{ secrets.SLACK_CODESECURITY_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "*Security scans:* some jobs failed :rotating_light:\nRepository: ${{ github.repository }}\nRun: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Open run>\n\n${{ steps.summary.outputs.summary }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Security scans:* some jobs failed :rotating_light:\n*Repository:* `${{ github.repository }}`\n*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Open run>\n\n${{ steps.summary.outputs.summary }}"
                  }
                }
              ]
            }
